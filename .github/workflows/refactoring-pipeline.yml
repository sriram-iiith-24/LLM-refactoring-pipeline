name: Automated Refactoring Pipeline

on:
  schedule:
    # Run every 24 hours at 00:00 UTC
    - cron: '0 0 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      interval_hours:
        description: 'Run interval in hours (default: 24)'
        required: false
        default: '24'

jobs:
  refactor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
      
      - name: Checkout target Java repository
        uses: actions/checkout@v4
        with:
          repository: sriram-iiith-24/project-1-team-40-copy
          path: code/repo-clone
          token: ${{ secrets.GH_PAT }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure environment
        env:
          GEMINI_KEY_1: ${{ secrets.GEMINI_KEY_1 }}
          GEMINI_KEY_2: ${{ secrets.GEMINI_KEY_2 }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "GEMINI_KEY_1=$GEMINI_KEY_1" >> .env
          echo "GEMINI_KEY_2=$GEMINI_KEY_2" >> .env
          echo "GITHUB_TOKEN=$GITHUB_TOKEN" >> .env
          echo "GITHUB_REPO=sriram-iiith-24/project-1-team-40-copy" >> .env
          echo "LOCAL_REPO_PATH=${{ github.workspace }}/code/repo-clone" >> .env
          echo "SCAN_MODE=large" >> .env
          echo "SCAN_MIN_LINES=300" >> .env
          echo "MAX_FILES_PER_RUN=20" >> .env
      
      - name: Run refactoring pipeline
        id: refactor
        run: |
          python3 main.py
        continue-on-error: true
      
      - name: Upload refactoring reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: refactoring-reports-${{ github.run_id }}
          path: refactoring_reports/
          retention-days: 30
      
      - name: Upload pipeline state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-state-${{ github.run_id }}
          path: refactoring_reports/pipeline_state.json
          retention-days: 90
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Refactoring Pipeline Failed',
              body: `The automated refactoring pipeline failed on run #${context.runNumber}.
              
              Check the logs: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            })
